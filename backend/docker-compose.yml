version: '3.8'

services:
  mongo:
    image: mongo:7.0
    container_name: password-security-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - password-security-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  s3:
    build:
      context: ./s3
      dockerfile: Dockerfile
    container_name: password-security-s3
    restart: unless-stopped
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      - MONGO_URI=${MONGO_URI:-mongodb://mongo:27017/passwordsecurity}
      - INTERNAL_SECRET=${INTERNAL_SECRET:-secreto_interno_123}
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - password-security-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 15s
      timeout: 5s
      retries: 3

  s2:
    build:
      context: ./s2
      dockerfile: Dockerfile
    container_name: password-security-s2
    restart: unless-stopped
    ports:
      - "50051:50051"
    environment:
      - NODE_ENV=production
      - GRPC_PORT=50051
      - S3_BASE_URL=${S3_BASE_URL:-http://s3:3003}
      - POLICY_CACHE_REFRESH_INTERVAL=60000
    depends_on:
      - s3
    networks:
      - password-security-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('net').connect(50051, 'localhost').on('connect', () => process.exit(0)).on('error', () => process.exit(1))"]
      interval: 15s
      timeout: 5s
      retries: 3

  s1:
    build:
      context: ./s1
      dockerfile: Dockerfile
    container_name: password-security-s1
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - JWT_SECRET=${JWT_SECRET:-super_secret_jwt_key_change_in_production}
      - JWT_EXPIRES_IN=1h
      - S3_BASE_URL=${S3_BASE_URL:-http://s3:3003}
      - S2_GRPC_HOST=${S2_GRPC_HOST:-s2}
      - S2_GRPC_PORT=${S2_GRPC_PORT:-50051}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TLS_CERT_PATH=/app/certs/server.crt
      - TLS_KEY_PATH=/app/certs/server.key
      - INTERNAL_SECRET=${INTERNAL_SECRET:-secreto_interno_123}
    volumes:
      - ./certs:/app/certs:ro
      - ./client-admin:/app/public/admin:ro
      - ./client-user:/app/public/user:ro
    depends_on:
      - s2
      - s3
    networks:
      - password-security-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('https').get({hostname:'localhost',port:3001,path:'/health',rejectUnauthorized:false}, (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 15s
      timeout: 5s
      retries: 3

networks:
  password-security-network:
    driver: bridge

volumes:
  mongo-data:
    driver: local
